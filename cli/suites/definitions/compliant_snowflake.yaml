# Compliant factor suite for Snowflake
# Factor 5: Is the data governed with explicit ownership, enforced access boundaries, and AI-specific safeguards?
# Reference: /factors.md â€” Compliant section
# Requirement keys match agent/requirements_registry.yaml
suite_name: compliant_snowflake
platform: snowflake

tests:
  - id: masking_policy_coverage
    factor: compliant
    requirement: masking_policy_coverage
    query: >-
      WITH pii_columns AS (
        SELECT table_catalog, table_schema, table_name, column_name
        FROM information_schema.columns
        WHERE UPPER(table_schema) NOT IN ('INFORMATION_SCHEMA', 'PG_CATALOG')
          AND (
            LOWER(column_name) LIKE '%email%'
            OR LOWER(column_name) LIKE '%phone%'
            OR LOWER(column_name) LIKE '%ssn%'
            OR LOWER(column_name) LIKE '%social_security%'
            OR LOWER(column_name) LIKE '%credit_card%'
            OR LOWER(column_name) LIKE '%card_number%'
            OR LOWER(column_name) LIKE '%password%'
            OR LOWER(column_name) LIKE '%secret%'
          )
      ),
      masked_columns AS (
        SELECT DISTINCT ref_database_name, ref_schema_name, ref_entity_name, ref_column_name
        FROM information_schema.policy_references
        WHERE policy_kind = 'MASKING_POLICY'
      )
      SELECT COUNT(mc.ref_column_name) * 1.0 / NULLIF(COUNT(pc.column_name), 0) AS v
      FROM pii_columns pc
      LEFT JOIN masked_columns mc
        ON pc.table_catalog = mc.ref_database_name
        AND pc.table_schema = mc.ref_schema_name
        AND pc.table_name = mc.ref_entity_name
        AND pc.column_name = mc.ref_column_name
    target_type: platform

  - id: row_access_policy_coverage
    factor: compliant
    requirement: row_access_policy_coverage
    query: >-
      WITH base_tables AS (
        SELECT table_catalog, table_schema, table_name
        FROM information_schema.tables
        WHERE UPPER(table_schema) NOT IN ('INFORMATION_SCHEMA', 'PG_CATALOG')
          AND table_type = 'BASE TABLE'
      ),
      tables_with_rap AS (
        SELECT DISTINCT ref_database_name, ref_schema_name, ref_entity_name
        FROM information_schema.policy_references
        WHERE policy_kind = 'ROW_ACCESS_POLICY'
      )
      SELECT COUNT(rap.ref_entity_name) * 1.0 / NULLIF(COUNT(bt.table_name), 0) AS v
      FROM base_tables bt
      LEFT JOIN tables_with_rap rap
        ON bt.table_catalog = rap.ref_database_name
        AND bt.table_schema = rap.ref_schema_name
        AND bt.table_name = rap.ref_entity_name
    target_type: platform

  - id: sensitive_column_tagged
    factor: compliant
    requirement: sensitive_column_tagged
    query: >-
      WITH sensitive_columns AS (
        SELECT table_catalog, table_schema, table_name, column_name
        FROM information_schema.columns
        WHERE UPPER(table_schema) NOT IN ('INFORMATION_SCHEMA', 'PG_CATALOG')
          AND (
            LOWER(column_name) LIKE '%email%'
            OR LOWER(column_name) LIKE '%phone%'
            OR LOWER(column_name) LIKE '%ssn%'
            OR LOWER(column_name) LIKE '%address%'
            OR LOWER(column_name) LIKE '%birth%'
            OR LOWER(column_name) LIKE '%salary%'
            OR LOWER(column_name) LIKE '%income%'
          )
      ),
      tagged_columns AS (
        SELECT DISTINCT object_database, object_schema, object_name, column_name
        FROM snowflake.account_usage.tag_references
        WHERE domain = 'COLUMN'
          AND LOWER(tag_name) IN ('pii', 'sensitive', 'confidential', 'phi', 'pci')
          AND deleted IS NULL
      )
      SELECT COUNT(tc.column_name) * 1.0 / NULLIF(COUNT(sc.column_name), 0) AS v
      FROM sensitive_columns sc
      LEFT JOIN tagged_columns tc
        ON sc.table_catalog = tc.object_database
        AND sc.table_schema = tc.object_schema
        AND sc.table_name = tc.object_name
        AND sc.column_name = tc.column_name
    target_type: platform
