# Current factor suite for Snowflake
# Factor 3: Does the data reflect the present state, with freshness enforced by systems?
# Reference: /factors.md â€” Current section
# Requirement keys match agent/requirements_registry.yaml
suite_name: current_snowflake
platform: snowflake

tests:
  - id: change_tracking_coverage
    factor: current
    requirement: change_tracking_coverage
    query: >-
      SELECT COUNT_IF(change_tracking = 'ON') * 1.0 / NULLIF(COUNT(*), 0) AS v
      FROM information_schema.tables
      WHERE UPPER(table_schema) NOT IN ('INFORMATION_SCHEMA', 'PG_CATALOG')
        AND table_type = 'BASE TABLE'
    target_type: platform

  - id: stream_coverage
    factor: current
    requirement: stream_coverage
    query: >-
      WITH base_tables AS (
        SELECT table_name
        FROM information_schema.tables
        WHERE UPPER(table_schema) NOT IN ('INFORMATION_SCHEMA', 'PG_CATALOG')
          AND table_type = 'BASE TABLE'
      ),
      tables_with_streams AS (
        SELECT DISTINCT base_tables
        FROM information_schema.streams
        WHERE UPPER(table_schema) NOT IN ('INFORMATION_SCHEMA', 'PG_CATALOG')
      )
      SELECT COUNT(s.base_tables) * 1.0 / NULLIF(COUNT(t.table_name), 0) AS v
      FROM base_tables t
      LEFT JOIN tables_with_streams s ON t.table_name = s.base_tables
    target_type: platform

  - id: data_freshness_pass_rate
    factor: current
    requirement: data_freshness_pass_rate
    query: >-
      SELECT COUNT_IF(last_altered > DATEADD('day', -7, CURRENT_TIMESTAMP())) * 1.0 / NULLIF(COUNT(*), 0) AS v
      FROM information_schema.tables
      WHERE UPPER(table_schema) NOT IN ('INFORMATION_SCHEMA', 'PG_CATALOG')
        AND table_type = 'BASE TABLE'
    target_type: platform

  - id: dynamic_table_coverage
    factor: current
    requirement: dynamic_table_coverage
    query: >-
      SELECT COUNT_IF(table_type = 'DYNAMIC TABLE') * 1.0 / 
             NULLIF(COUNT_IF(table_type IN ('VIEW', 'DYNAMIC TABLE')), 0) AS v
      FROM information_schema.tables
      WHERE UPPER(table_schema) NOT IN ('INFORMATION_SCHEMA', 'PG_CATALOG')
    target_type: platform
