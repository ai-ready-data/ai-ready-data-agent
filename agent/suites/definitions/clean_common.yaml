# Clean factor suite for DuckDB â€” migrated from clean_duckdb.py
# Requirement keys match agent/requirements_registry.yaml
suite_name: common
platform: duckdb

tests:
  - id: clean_table_count
    factor: clean
    requirement: table_discovery
    query: >-
      SELECT COUNT(*) AS cnt FROM information_schema.tables
      WHERE table_schema NOT IN ('information_schema', 'pg_catalog')
    target_type: platform

  - id: null_rate
    factor: clean
    requirement: null_rate
    query_template: >-
      SELECT COUNT(*) FILTER (WHERE {column_q} IS NULL) * 1.0 / NULLIF(COUNT(*), 0) AS v
      FROM {schema_q}.{table_q}
    target_type: column

  - id: duplicate_rate
    factor: clean
    requirement: duplicate_rate
    query_template: >-
      SELECT 1.0 - (SELECT COUNT(*)::DOUBLE FROM (SELECT DISTINCT * FROM {schema_q}.{table_q}) _) /
      NULLIF((SELECT COUNT(*)::DOUBLE FROM {schema_q}.{table_q}), 0) AS v
    target_type: table

  - id: zero_negative_rate
    factor: clean
    requirement: zero_negative_rate
    query_template: >-
      SELECT COUNT(*) FILTER (WHERE {column_q} <= 0) * 1.0 / NULLIF(COUNT(*), 0) AS v
      FROM {schema_q}.{table_q}
    target_type: column

  - id: type_inconsistency_rate
    factor: clean
    requirement: type_inconsistency_rate
    query_template: >-
      SELECT COUNT(*) FILTER (WHERE {column_q} IS NOT NULL AND TRY_CAST({column_q} AS DOUBLE) IS NULL) * 1.0 / NULLIF(COUNT(*), 0) AS v
      FROM {schema_q}.{table_q}
    target_type: column

  - id: format_inconsistency_rate
    factor: clean
    requirement: format_inconsistency_rate
    query_template: >-
      SELECT COUNT(*) FILTER (WHERE {column_q} IS NOT NULL AND TRY_CAST({column_q} AS DATE) IS NULL) * 1.0 / NULLIF(COUNT(*), 0) AS v
      FROM {schema_q}.{table_q}
    target_type: column

