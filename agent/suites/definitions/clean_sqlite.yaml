# Clean factor suite for SQLite â€” migrated from clean_sqlite.py
# Requirement keys match agent/requirements_registry.yaml
suite_name: common_sqlite
platform: sqlite

tests:
  - id: clean_table_count
    factor: clean
    requirement: table_discovery
    query: >-
      SELECT COUNT(*) AS cnt FROM sqlite_master
      WHERE type = 'table' AND name NOT LIKE 'sqlite_%'
    target_type: platform

  - id: null_rate
    factor: clean
    requirement: null_rate
    query_template: >-
      SELECT CAST(SUM(CASE WHEN {column_q} IS NULL THEN 1 ELSE 0 END) AS REAL) / NULLIF(COUNT(*), 0) AS v
      FROM {schema_q}.{table_q}
    target_type: column

  - id: duplicate_rate
    factor: clean
    requirement: duplicate_rate
    query_template: >-
      SELECT 1.0 - 1.0 * (SELECT COUNT(*) FROM (SELECT DISTINCT * FROM {schema_q}.{table_q})) /
      NULLIF((SELECT COUNT(*) FROM {schema_q}.{table_q}), 0) AS v
    target_type: table

  - id: zero_negative_rate
    factor: clean
    requirement: zero_negative_rate
    query_template: >-
      SELECT CAST(SUM(CASE WHEN {column_q} <= 0 THEN 1 ELSE 0 END) AS REAL) / NULLIF(COUNT(*), 0) AS v
      FROM {schema_q}.{table_q}
    target_type: column

  - id: type_inconsistency_rate
    factor: clean
    requirement: type_inconsistency_rate
    query_template: >-
      SELECT CAST(SUM(CASE WHEN {column_q} IS NOT NULL AND TRY_CAST({column_q} AS REAL) IS NULL THEN 1 ELSE 0 END) AS REAL) / NULLIF(COUNT(*), 0) AS v
      FROM {schema_q}.{table_q}
    target_type: column

  - id: format_inconsistency_rate
    factor: clean
    requirement: format_inconsistency_rate
    query_template: >-
      SELECT CAST(SUM(CASE WHEN {column_q} IS NOT NULL AND date({column_q}) IS NULL THEN 1 ELSE 0 END) AS REAL) / NULLIF(COUNT(*), 0) AS v
      FROM {schema_q}.{table_q}
    target_type: column

